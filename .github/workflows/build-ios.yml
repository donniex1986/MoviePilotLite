# MoviePilot - iOS 打包 Workflow
# 触发器: 每周五 UTC 00:00 自动执行 | 支持手动触发
# 输出: 创建 GitHub Release，上传未签名应用

name: Build iOS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 5"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.home }}/Library/Caches/CocoaPods
            ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Run iOS CI script
        env:
          CI_PRIMARY_REPOSITORY_PATH: ${{ github.workspace }}
        run: bash ios/ci_scripts/ci_post_clone.sh

      - name: Add Flutter to PATH
        run: echo "$HOME/flutter/bin" >> $GITHUB_PATH

      - name: Install Fastlane
        run: brew install fastlane

      - name: Build iOS App (Unsigned)
        run: |
          flutter build ios --no-codesign
          # 创建一个简单的 zip 文件用于上传
          mkdir -p build/ios/unsigned
          cp -r build/ios/iphoneos/Runner.app build/ios/unsigned/
          cd build/ios/unsigned
          zip -r Runner.app.zip Runner.app
          cd ../../../
          echo "UNSIGNED_BUILD=true" >> $GITHUB_ENV

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | sed 's/+.*//' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate release name
        id: release_name
        run: |
          RELEASE_NAME="ios-$(date +%Y-%m-%d-%H-%M)-${{ steps.version.outputs.version }}"
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ steps.release_name.outputs.name }}
          name: ${{ steps.release_name.outputs.name }}
          body: |
            MoviePilot iOS Release
            - Build: ${{ steps.release_name.outputs.name }}
            - Version: ${{ steps.version.outputs.version }}
            - Type: Unsigned
          files: build/ios/unsigned/Runner.app.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
