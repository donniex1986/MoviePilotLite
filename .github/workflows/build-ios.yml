name: Build iOS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 5"   # ÊØèÂë®‰∫î UTC 00:00

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.2"
          channel: "stable"
          cache: true

      # 3Ô∏è‚É£ Cache pub dependencies
      - name: Cache Flutter pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # 4Ô∏è‚É£ Install Dart/Flutter dependencies
      - name: Install dependencies
        run: flutter pub get

      # 5Ô∏è‚É£ Cache CocoaPods
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # 6Ô∏è‚É£ Install Pods
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..

      # 7Ô∏è‚É£ Build unsigned iOS app
      - name: Build iOS (Unsigned)
        run: |
          flutter build ios --release --no-codesign --dart-define=FLUTTER_APP_ENV=release

          cd build/ios/iphoneos

          mkdir -p Payload
          cp -R Runner.app Payload/

          # ÁîüÊàêÊ†áÂáÜ IPA
          zip -r -y app-unsigned.ipa Payload

          # ÁîüÊàê SHA256 Ê†°È™å
          shasum -a 256 app-unsigned.ipa > app-unsigned.ipa.sha256

          cd ../../..

      # 8Ô∏è‚É£ Ëé∑ÂèñÁâàÊú¨Âè∑
      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | sed 's/+.*//' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 9Ô∏è‚É£ ÁîüÊàê Release ÂêçÁß∞
      - name: Generate release name
        id: release
        run: |
          RELEASE_NAME="v${{ steps.version.outputs.version }}-ios-$(date +%Y-%m-%d)"
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT

      # üîü ÂàõÂª∫ GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.name }}
          name: ${{ steps.release.outputs.name }}
          body: |
            ## MoviePilot iOS Release

            - Version: ${{ steps.version.outputs.version }}
            - Build Date: $(date +%Y-%m-%d)
            - Type: Unsigned IPA

            ### ‚ö†Ô∏è Installation

            This IPA is **unsigned**.

            Please sign it using your own Apple Developer account via:

            - AltStore
            - Sideloadly
            - Xcode

            Free Apple ID accounts expire after 7 days.

          files: |
            build/ios/iphoneos/app-unsigned.ipa
            build/ios/iphoneos/app-unsigned.ipa.sha256

          generate_release_notes: true

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}