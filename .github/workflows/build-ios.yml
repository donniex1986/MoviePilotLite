# MoviePilot - iOS 打包 Workflow
# 触发器: 每周五 UTC 00:00 自动执行 | 支持手动触发
# 输出: 创建 GitHub Release，上传 IPA

name: Build iOS

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 5'

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run iOS CI script
        env:
          CI_PRIMARY_REPOSITORY_PATH: ${{ github.workspace }}
        run: bash ios/ci_scripts/ci_post_clone.sh

      - name: Add Flutter to PATH
        run: echo "$HOME/flutter/bin" >> $GITHUB_PATH

      - name: Setup iOS Code Signing
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain || true
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          echo "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security || true

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          uuid=$(grep -aA1 UUID profile.mobileprovision | grep -o "[-A-Za-z0-9]\{36\}" | head -1)
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision
          echo "PROVISIONING_PROFILE_UUID=$uuid" >> $GITHUB_ENV

          echo "CODE_SIGN_IDENTITY=iPhone Distribution" >> $GITHUB_ENV
          echo "CODE_SIGN_STYLE=Automatic" >> $GITHUB_ENV

      - name: Install Fastlane
        run: brew install fastlane

      - name: Build iOS IPA
        env:
          PROVISIONING_PROFILE_UUID: ${{ env.PROVISIONING_PROFILE_UUID }}
          CODE_SIGN_IDENTITY: "iPhone Distribution"
          CODE_SIGN_STYLE: "Automatic"
        run: |
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain || true
          fastlane ios

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | sed 's/+.*//' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate release name
        id: release_name
        run: |
          RELEASE_NAME="ios-$(date +%Y-%m-%d-%H-%M)-${{ steps.version.outputs.version }}"
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ steps.release_name.outputs.name }}
          name: ${{ steps.release_name.outputs.name }}
          body: |
            MoviePilot iOS Release
            - Build: ${{ steps.release_name.outputs.name }}
            - Version: ${{ steps.version.outputs.version }}
          files: build/ios/ipa/*.ipa
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
