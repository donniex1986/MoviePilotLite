# MoviePilot Mobile - Release 打包 Workflow
# 触发器: 每周五 UTC 00:00 自动执行 | 支持手动触发
# 输出: 创建 GitHub Release，上传 APK 和 IPA
# Release 名称格式: yyyy-MM-dd-HH:mm-{version}

name: Release Build

on:
  workflow_dispatch:
  schedule:
    # 每周五 UTC 00:00 (北京时间 08:00)
    - cron: '0 0 * * 5'

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Flutter precache
        run: flutter precache --ios --android

      - name: Install CocoaPods dependencies
        run: |
          cd ios && pod install && cd ..

      - name: Decode Android Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > $RUNNER_TEMP/moviepilot.keystore
          echo "ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/moviepilot.keystore" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Setup iOS Code Signing
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 != '' }}
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          echo "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          uuid=$(grep -aA1 UUID profile.mobileprovision | grep -o "[-A-Za-z0-9]\{36\}" | head -1)
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

      - name: Flutter pub get
        run: flutter pub get

      - name: Install Fastlane
        run: brew install fastlane

      - name: Build Android APK
        run: fastlane android

      - name: Build iOS IPA
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 != '' }}
        run: fastlane ios

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | sed 's/+.*//' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate release name
        id: release_name
        run: |
          RELEASE_NAME="$(date +%Y-%m-%d-%H-%M)-${{ steps.version.outputs.version }}"
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "Release name: $RELEASE_NAME"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ steps.release_name.outputs.name }}
          name: ${{ steps.release_name.outputs.name }}
          body: |
            MoviePilot Mobile Release
            - Build: ${{ steps.release_name.outputs.name }}
            - Version: ${{ steps.version.outputs.version }}
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/ios/ipa/*.ipa
          fail_on_unmatched_files: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
